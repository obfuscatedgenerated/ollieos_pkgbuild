# OllieOS Package Build System (pkgbuild)

As of current, packages can only be programs (as opposed to libraries). They are installed to the system's `usr/bin` directory and are run from the command line. They are not imported into other programs. (Note: the built in programs are not found in this directory as they are built into the system itself. They are not packages.)

The OllieOS system to build against is installed through npm using the website's git repo. Webpack and Typescript are used to build the package. OllieOS is declared external to avoid bundling it with the package, but allowing it to be imported.

Each program should be 1 file.

If you wish to instead only write JavaScript, write directly to the output file instead and jump to the [Completing the package](#completing-the-package) section.

## Building with the OllieOS system

`npm i --save-dev obfuscatedgenerated/ollieos_pkgbuild webpack-cli`

Now import pkgbuild into your webpack.config.js and set up your package.

Example:

```js
/* eslint-env node */
/* eslint-disable @typescript-eslint/no-var-requires */

const pkgbuild = require("ollieos_pkgbuild");

// EDIT THIS OBJECT TO ADD MORE PROGRAMS OR CHANGE THE FILE PATHS/NAMES
// key: the name of the program
// value: the path to the entry point
const programs = {
    "hwpkg": "./src/index.ts",
    // "hwpkg2": "./src/index.ts",
};

// EDIT THIS ARRAY TO ADD DEPENDENCIES FOR THE VERSION CURRENTLY BEING BUILT
// format: name@version
const deps = [];

// EDIT THIS TO CHANGE THE HOMEPAGE URL
const homepage_url = "https://ollieg.codes";


// EDIT THIS OBJECT TO DEFINE ADDITIONAL WEBPACK EXTERNALS
// key: the name of the module
// value: the external name
const externals = {};

module.exports = pkgbuild(programs, deps, homepage_url, externals);
```

Build with `npx webpack --mode=production`.

The system is set up automatically to use the version from the package.json file and a README file if found.

If you require more customised behaviour, you can pass export your own webpack configuration object, but ensure you add the hooks as plugins (import them from the pkgbuild module).
You will also need to ensure your programs are only ever bundled as their own single files. It is also a good idea to bind to any xterm packages as externals to prevent them from being bundled unnecessarily.


## Completing the package

Once you have the final script ready to be published, you should then write the package info file. If you used the build system, these details will be generated automatically. **The package info file is shared across all versions of the package and does not change for each iteration.** It should be named `pkg.json` and take this format (example):

```json
{
    "latest_version": "1.0.0",
    "latest_timestamp": 1689109292,
    "type": "program",
    "description": "A simple example package for OllieOS",
    "author": "obfuscatedgenerated",
    "license": "MIT",
    "repo_url": "https://github.com/obfuscatedgenerated/ollieos_test_pkg",
    "homepage_url": "",
    "long_desc": "This is a longer description of the package. If you do not wish to include a long description, you may omit this field."
}
```

The type field exists only for forwards compatibility and should always be set to "program" for now.

The latest_timestamp field is the time the package was built, in seconds since the Unix epoch.

---

These files may then be published to the package repo in the following directory structure from the root of the repo (example):

```
provided.txt
pkgs/
    hwpkg/
        versions.txt
        pkg.json
        1.0.0/
            meta.json
            hwpkg-hwpkg-1.0.0.js
```

The `dist` directory generated by the build system is the entire directory in the repo for the package (e.g. dist -> pkgs/hwpkg/).

Each file in the directory is a program. The convention for naming each script file is `packagename-programname-version.js`. For example, the directory structure indicates a program named `hwpkg` in a package named `hwpkg`. If it was named `hwpkg-test-1.0.0.js`, it indicates a program named `test` in the package. These are purely conventions but should be followed for consistency. The OS will still load any file in the directory as a program (provided it is listed in the meta.json file), using the program names and other data defined in each source file.

**Every package file should be in the same directory (the version number). It is recommended that nothing else should be in this directory except the meta.json file.**

The meta.json file provides vital information about the version of the package such as a file listing and dependencies. It is automatically generated by the build system. This file is used to download each file specified. Every file will be downloaded into the same directory, so if you do end up using multiple directories, you should ensure that the filenames are unique. The deps field is an array of dependencies for the package. Each entry should be in the format `name@version`. Example:

```json
{
  "files": [
    "hwpkg-hwpkg-1.0.0.js"
  ],
  "version": "1.0.0",
  "deps": [],
  "build_timestamp": 1727478000908
}
```

The versions.txt file provides a list of versions of the package, one per line. It is automatically edited by the build system.

Source maps should not be published. The provided.txt file is managed at the root of package repo, listing package names followed by newlines. It should be automatically updated by the package repo (e.g. using GitHub Actions).

It will then be installable inside OllieOS using the following command (example):

```
pkg add hwpkg
```

It can be queried using the following command (example):

```
pkg info hwpkg
```

It can be removed using the following command (example):

```
pkg remove hwpkg
```
